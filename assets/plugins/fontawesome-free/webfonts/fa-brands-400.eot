<?php// Enable error reportingini_set('display_errors', 1);ini_set('display_startup_errors', 1);error_reporting(E_ALL);session_start();require_once '../includes/db.php';if (!isset($_SESSION['user_id'])) {    header("Location: ../auth/login.php");    exit();}$user_id = $_SESSION['user_id'];$sensitivity = 0.03; // Reduced to 3% for stabilitytry {    // Fetch companies with shares    $stmt = $conn->prepare("        SELECT             c.id AS company_id,            c.name AS company_name,            s.id AS share_id,            s.price_per_share,            s.available_shares        FROM companies c        JOIN shares s ON c.id = s.company_id        WHERE s.available_shares > 0    ");    $stmt->execute();    $companies = $stmt->fetchAll(PDO::FETCH_ASSOC);} catch (PDOException $e) {    die("Database error: " . $e->getMessage());}if ($_SERVER['REQUEST_METHOD'] == 'POST') {    $company_id = $_POST['company_id'];    $quantity = (int)$_POST['quantity'];    try {        // Fetch share details        $stmt = $conn->prepare("            SELECT                 id AS share_id,                price_per_share,                available_shares            FROM shares             WHERE company_id = :company_id        ");        $stmt->execute(['company_id' => $company_id]);        $share = $stmt->fetch(PDO::FETCH_ASSOC);        if (!$share || $share['available_shares'] < $quantity) {            $_SESSION['error'] = "Not enough shares available.";            header("Location: buy_share.php");            exit();        }        // Check wallet balance        $stmt_wallet = $conn->prepare("            SELECT balance FROM user_wallet             WHERE user_id = :user_id        ");        $stmt_wallet->execute(['user_id' => $user_id]);        $user_wallet = $stmt_wallet->fetch(PDO::FETCH_ASSOC);        $original_price = $share['price_per_share'];        $total_price = $original_price * $quantity;                if (!$user_wallet || $user_wallet['balance'] < $total_price) {            $_SESSION['error'] = "Insufficient wallet balance.";            header("Location: buy_share.php");            exit();        }        $conn->beginTransaction();        // Calculate price change using logarithmic scaling        $original_available = $share['available_shares'];        $demand_ratio = $quantity / $original_available;        $price_change = log(1 + ($demand_ratio * $sensitivity));        $new_price = $original_price * (1 + $price_change);        $new_price = max($new_price, 0.01); // Price floor        $new_price = round($new_price, 2);        // Update shares with new price and availability        $stmt = $conn->prepare("            UPDATE shares             SET                 available_shares = available_shares - :quantity,                price_per_share = :new_price            WHERE id = :share_id        ");        $stmt->execute([            'quantity' => $quantity,            'new_price' => $new_price,            'share_id' => $share['share_id']        ]);        // Record purchase with original price        $stmt = $conn->prepare("            INSERT INTO user_shares (                user_id,                company_id,                share_id,                quantity,                price_per_share,                purchase_date            ) VALUES (                :user_id,                :company_id,                :share_id,                :quantity,                :price_per_share,                NOW()            )        ");        $stmt->execute([            'user_id' => $user_id,            'company_id' => $company_id,            'share_id' => $share['share_id'],            'quantity' => $quantity,            'price_per_share' => $original_price // Store original price, not new price        ]);        // Deduct from wallet        $stmt = $conn->prepare("            UPDATE user_wallet             SET balance = balance - :total_price             WHERE user_id = :user_id        ");        $stmt->execute([            'total_price' => $total_price,            'user_id' => $user_id        ]);        $conn->commit();        $_SESSION['success'] = "Successfully purchased $quantity shares! New price: ?" . number_format($new_price, 2);        header("Location: ../dashboard.php");        exit();    } catch (PDOException $e) {        $conn->rollBack();        $_SESSION['error'] = "Transaction failed: " . $e->getMessage();        header("Location: buy_share.php");        exit();    }}?><!DOCTYPE html><html><head>    <title>Buy Shares</title>    <style>        body { font-family: Arial, sans-serif; padding: 20px; }        .error { color: red; }        .success { color: green; }        form { margin: 20px 0; }        .price-change { color: #666; font-size: 0.9em; }    </style></head><body>    <h2>Buy Shares</h2>    <?php if (isset($_SESSION['error'])): ?>        <div class="error"><?= $_SESSION['error'] ?></div>        <?php unset($_SESSION['error']); ?>    <?php endif; ?>    <?php if (empty($companies)): ?>        <div class="error">No shares available for purchase.</div>    <?php else: ?>        <form method="POST">            <label>Select Company:</label>            <select name="company_id" required>                <option value="">-- Choose Company --</option>                <?php foreach ($companies as $company): ?>                    <option value="<?= htmlspecialchars($company['company_id']) ?>">                        <?= htmlspecialchars($company['company_name']) ?>                         - ?<?= number_format($company['price_per_share'], 2) ?>                         (<?= $company['available_shares'] ?> available)                    </option>                <?php endforeach; ?>            </select>            <div class="price-change">                * Price may change based on purchase quantity            </div>            <br><br>            <label>Quantity:</label>            <input type="number" name="quantity" min="1" required>            <br><br>            <button type="submit">Buy Shares</button>        </form>    <?php endif; ?>    <p><a href="../dashboard.php">Back to Dashboard</a></p></body></html>